<HTML>
<HEAD>
<TITLE>Notes about Building Tensorflow (CUDA) and Tensorflow Serving with Bazel</TITLE>
</HEAD>

<H1>Irtaza's Blog</H1>

<H2>Setting up the CUDA 7.5 and cudnn-7.0 v4.0 on Ubuntu 15.04 </H2>
<H3>GPU Hardware NVIDIA GeForce 840m. compute capability = 5.0</H3>
<br>
Skipping the earlier steps....:
<br>
//For post installations steps mentioned in CUDA_installation_linux.pdf
<br>
export PATH=/usr/local/cuda-7.5/bin:$PATH<br>
export LD_LIBRARY_PATH=/usr/local/cuda-7.5/lib64:$LD_LIBRARY_PATH<br>
add to :<br>

$ ~/.profile<br> 

Now you need to log in and logged out to load ~/.profile<br>
however there is a work around this by sourcing<br>
<br>
NVIDIA DRIVER VERSION was VERIFIED using<br>
$ cat /proc/driver/nvidia/version<br>
<br>
Output: <br>
NVRM version: NVIDIA UNIX x86_64 Kernel Module  352.79  Wed Jan 13 16:17:53 PST 2016<br>
GCC version:  gcc version 4.9.2 (Ubuntu 4.9.2-10ubuntu13) <br>
<br>
//Test Samples need to be $make<br>
irtza@irtzaPC:~/cuda_samples/NVIDIA_CUDA-7.5_Samples/1_Utilities/deviceQuery $ make <br>
<br>
//Run the binaries from the same directory using <br>
$./deviceQuery<br>

If the following steps are completed, a critical portion of the entire setup is done!<br>
<br>
git was Set up<br>
<br>
Bazel pre-requisites were installed from here.<br>
http://bazel.io/docs/install.html<br>
<br>
$ sudo apt-get install openjdk-8-jdk<br>
<br>
//JDK 8 Success! <br>
<br>
Bazel installed in home/bin<br>
PATH was set in ~/.bashsrc<br>
<br>
gRpc installed !<br>
$ pip install grpcio<br>
<br>
=============================================================<br>
ALL TENSORFLOW dependencies Bulk installed..<br>
Problem with conda? hope not !<br>
If there is a problem with CONDA use Tensorflow in a virtual env <br>
<br>
BULK install tensorflow dependencies :<br>
<br>
$ sudo apt-get update && sudo apt-get install -y \<br>
>         build-essential \<br>
>         curl \<br>
>         git \<br>
>         libfreetype6-dev \<br>
>         libpng12-dev \<br>
>         libzmq3-dev \<br>
>         pkg-config \<br>
>         python-dev \<br>
>         python-numpy \<br>
>         python-pip \<br>
>         software-properties-common \<br>
>         swig \<br>
>         zip \<br>
>         zlib1g-dev<br>
<br>
<br>
Tensorflow Serving was Repo Cloned --recurse-submodule also clones all the dependencies such as grpc.io<br>
<br>
Recurse submodules also clones its dependencies and so it also cloned tensorflow<br>
<br>
$ git clone --recurse-submodules https://github.com/tensorflow/serving<br>
<br>
latest CudNN v4 was installed<br>
<br>
extracted into /usr/local/cuda<br>
extracted it there... <br>
<br>
version: <br>
	cudnn-7.0-linux-x64-v4.0-prod.tgz<br>
<br>
Run ./Configure script in cloned repository : /serving/Tensorflow<br>
<br>
$ ./configure<br>
<br>
==OUTPUT and choices===================================================<br>
irtza@irtzaPC:~/serving/tensorflow$ ./configure<br>
Please specify the location of python. [Default is /home/irtza/Downloads/enter/bin/python]: /home/irtza/Downloads/enter/bin/python<br>
Do you wish to build TensorFlow with GPU support? [y/N] y<br>
GPU support will be enabled for TensorFlow<br>
Please specify the Cuda SDK version you want to use, e.g. 7.0. [Leave empty to use system default]: 7.5<br>
Please specify the location where CUDA 7.5 toolkit is installed. Refer to README.md for more details. [Default is /usr/local/cuda]: /usr/local/cuda-7.5<br>
Please specify the Cudnn version you want to use. [Leave empty to use system default]: v4<br>
Please specify the location where cuDNN v4 library is installed. Refer to README.md for more details. [Default is /usr/local/cuda-7.5]: <br>
Invalid path to cuDNN v4 toolkit. Neither of the following two files can be found:<br>
/usr/local/cuda-7.5/lib64/libcudnn.so.v4<br>
/usr/local/cuda-7.5/libcudnn.so.v4<br>
.v4<br>
Please specify the Cudnn version you want to use. [Leave empty to use system default]: <br>
Please specify the location where cuDNN  library is installed. Refer to README.md for more details. [Default is /usr/local/cuda-7.5]: <br>
Please specify a list of comma-separated Cuda compute capabilities you want to build with.<br>
You can find the compute capability of your device at: https://developer.nvidia.com/cuda-gpus.<br>
Please note that each additional compute capability significantly increases your build time and binary size.<br>
[Default is: "3.5,5.2"]: <br>
5.0<br>
Setting up Cuda include<br>
Setting up Cuda lib64<br>
Setting up Cuda bin<br>
Setting up Cuda nvvm<br>
Configuration finished<br>
<br>
//Things look successfull here. Going back to tensorflow tutorial<br>
===============IMPORTANT=====================================<br>
// BEFORE BUILDING with Bazel check Bazel documentation<br>
// ALWAYS use "--local_resources 2048,0.5,1.0" option with Bazel<br>
// to keep shell active and avoid compiler crashes..<br>
// the values after this option are RAM in MB , processor <br>
// capacity, and IO useage<br>
<br>
=====================================================<br>
	$ bazel build -c opt --local_resources 2048,0.5,1.0 --config=cuda //tensorflow/cc:tutorials_example_trainer<br>
<br>
//successful!<br>
//GPU test passed<br> 
<br>
	$ bazel-bin/tensorflow/cc/tutorials_example_trainer --use_gpu<br>
<br>
//Buiding PIP package..<br>
<br>
	$ bazel build -c opt //tensorflow/tools/pip_package:build_pip_package<br>
<br>
//Building PIP pacakage with --config=cuda<br>
<br>
	$ bazel build -c opt --config=cuda //tensorflow/tools/pip_package:build_pip_package<br>
<br>
	$ bazel-bin/tensorflow/tools/pip_package/build_pip_package /tmp/tensorflow_pkg<br>
<br>
# The name of the .whl file will depend on your platform.<br>
	$ pip install /tmp/tensorflow_pkg/tensorflow-0.7.1-py2-none-linux_x86_64.whl<br>
<br>
=======OPtional==========<br>
//// If you're developing TensorFlow itself <br>
<br>
	bazel build -c opt //tensorflow/tools/pip_package:build_pip_package<br>
	mkdir _python_build<br>
	cd _python_build<br>
	ln -s ../bazel-bin/tensorflow/tools/pip_package/build_pip_package.runfiles/* .<br>
	ln -s ../tensorflow/tools/pip_package/* .<br>
	python setup.py develop<br>
<br>
======== i didnt do it However============<br>
Create the pip package and install<br>
<br>
When building from source, you will still build a pip package and install that.<br>
<br>
<br>
$ bazel build -c opt //tensorflow/tools/pip_package:build_pip_package<br>
<br>
To build with GPU support:<br>
<br>
$ bazel build -c opt --config=cuda //tensorflow/tools/pip_package:build_pip_package<br>
<br>
$ bazel-bin/tensorflow/tools/pip_package/build_pip_package /tmp/tensorflow_pkg<br>
<br>
The name of the .whl file will depend on your platform.<br>
$ pip install /tmp/tensorflow_pkg/tensorflow-0.7.1-py2-none-linux_x86_64.whl<br>
<br>
<br>
$ pip install /tmp/tensorflow_pkg/tensorflow-0.7.1-py2-none-linux_x86_64.whl<br>


=======================================================<br>
<br>

<h4> Failure in setting up Tensorflow Serving!</h4>>
$bazel build --local_resources 3072,0.5,1.0 tensorflow_serving/...<br>
<br>
// https://tensorflow.github.io/serving/setup<br>
<br>

<p>ERROR: /home/irtza/serving/tensorflow_serving/session_bundle/example/BUILD:34:1: Executing genrule //tensorflow_serving/session_bundle/example:half_plus_two failed: bash failed: error executing command /bin/bash -c ... (remaining 1 argument(s) skipped).
RuntimeError: module compiled against API version a but this version of numpy is 9
</p>


<br>
<P> This is a new paragraph!<br>
<br>
<P> <B>This is a new paragraph!</B><br>
<br>
<BR> <B><I>This is a new sentence without a paragraph break, in bold italics.</I></B><br>
<HR><br>
<br>
Write to me at: <a href="mailto:irtzali@gmail.com"><br>
irtzali@gmail.com</a>.<br>
<br>
</BODY>
</HTML> 
